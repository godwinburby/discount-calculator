<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discount Calculator Pro</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles for aesthetics and mobile feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .input-field {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
            outline: none;
        }
        /* Custom class for validation error */
        .input-error {
            border-color: #ef4444 !important; /* Red-500 */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
        }

        /* Desktop-specific styles for product row to enable tabular view */
        @media (min-width: 768px) {
            .product-row-desktop-grid {
                /* 10 Columns: Number, Name, Price, Units, Subtotal, Discount Setup, Discount Amt, Discount %, Final Price, Remove Btn */
                grid-template-columns: 0.5fr 1.5fr 1fr 0.7fr 1fr 2fr 1fr 0.8fr 1.2fr auto; 
                display: grid;
                align-items: center;
                gap: 1rem;
                padding: 1rem 1.5rem;
            }
            .product-row .mobile-only-details {
                display: none; /* Hide stacked details on desktop */
            }
            /* Style for the calculated outputs */
            .calculated-output {
                font-size: 0.9rem;
                font-weight: 600;
                text-align: right;
                padding-right: 4px;
            }
            .calculated-output.final {
                font-size: 1rem;
                font-weight: 700;
            }
        }

        /* Modal specific styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* Controlled by JS */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.2s ease-out;
        }
        .modal.open .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-7xl mx-auto"> 
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Discount Calculator Pro</h1>
            <p class="text-gray-500">Manage multiple products, complex discounts, and calculate tax.</p>
        </header>

        <main class="bg-white p-6 rounded-xl container-card space-y-6">
            
            <!-- Quote Management Section -->
            <div class="border-b pb-4 mb-4 space-y-3">
                <h2 class="text-xl font-semibold text-gray-700">Quote Management</h2>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <!-- Quote Name Input -->
                    <div class="sm:flex-grow">
                        <input
                            type="text"
                            id="quote-name-input"
                            placeholder="Current Quote Name"
                            class="input-field w-full text-base font-medium"
                            oninput="setCurrentQuoteName(this.value)"
                        />
                    </div>

                    <!-- Action Buttons -->
                    <button id="save-quote-btn" onclick="saveQuoteLocally()" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-200 shadow-md flex-shrink-0">
                        ðŸ’¾ Save Quote
                    </button>
                    <button id="clear-quote-btn" onclick="clearQuote()" class="w-full sm:w-auto bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-200 shadow-md flex-shrink-0">
                        âœ¨ Clear Quote
                    </button>
                    <!-- NEW: History Modal Button -->
                    <button id="open-history-btn" onclick="openHistoryModal()" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-200 shadow-md flex-shrink-0">
                        ðŸ“š Quote History
                    </button>
                </div>
            </div>

            <!-- Global Tax Input -->
            <div class="mb-6 max-w-sm mx-auto p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                <label for="global-tax-input" class="block text-sm font-medium text-gray-700 mb-2">
                    Global Sales Tax / GST (%)
                </label>
                <div class="flex items-center space-x-2">
                    <input
                        type="number"
                        min="0"
                        step="0.1"
                        id="global-tax-input"
                        value="0"
                        class="input-field w-full text-lg font-medium text-center"
                        oninput="handleGlobalTaxInput(event)"
                    />
                    <span class="text-xl font-bold text-gray-600">%</span>
                </div>
            </div>

            <!-- Product List Header (Desktop Only - 10 Columns) -->
            <div class="hidden md:grid md:grid-cols-[0.5fr_1.5fr_1fr_0.7fr_1fr_2fr_1fr_0.8fr_1.2fr_auto] gap-4 mb-2 p-4 border-b border-gray-300 font-semibold text-gray-600">
                <span>#</span> <!-- NEW COLUMN FOR PRODUCT NUMBER -->
                <span>Product Name</span>
                <span>Unit Price (â‚¹)</span>
                <span>Units</span>
                <span class="text-right">Subtotal (â‚¹)</span>
                <span class="text-center">Discount Setup</span>
                <span class="text-right">Discount Amt (â‚¹)</span>
                <span class="text-right">Discount %</span>
                <span class="text-right">Final Price (â‚¹)</span>
                <span class="w-6"></span> <!-- Spacer for delete button -->
            </div>

            <!-- Product List Area -->
            <div id="product-list" class="space-y-4">
                <h2 class="text-xl font-semibold border-b pb-2 text-gray-700 md:hidden">Products</h2>
                <!-- Product rows will be inserted here -->
            </div>

            <!-- Action Button: DIRECT BINDING for reliability -->
            <button id="add-product-btn" onclick="addProduct()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-xl transition duration-200 shadow-md">
                + Add New Product
            </button>

            <!-- Totals Summary Area -->
            <div id="totals-summary" class="pt-6 border-t border-gray-200 mt-6">
                <h2 class="text-xl font-semibold mb-3 text-gray-700 text-center md:text-left">Summary</h2>
                <!-- Global Summary remains the same -->
                <div class="space-y-3 p-4 bg-gray-50 rounded-lg max-w-sm mx-auto"> 
                    
                    <div class="flex justify-between text-base">
                        <span class="text-gray-600">Total Subtotal:</span>
                        <span id="total-subtotal" class="font-medium text-gray-800">â‚¹0.00</span>
                    </div>
                    
                    <div class="flex justify-between text-base">
                        <span class="text-gray-600">Total Discount:</span>
                        <span id="total-discount" class="font-medium text-red-500">-â‚¹0.00</span>
                    </div>

                    <div class="flex justify-between text-base">
                        <span class="text-gray-600">Net Payable Amount (before Tax):</span>
                        <span id="net-payable-amount" class="font-medium text-indigo-500">â‚¹0.00</span>
                    </div>

                    <div class="flex justify-between text-base border-t pt-2">
                        <span class="text-gray-600">Tax (0.0%):</span>
                        <span id="tax-amount" class="font-medium text-gray-800">â‚¹0.00</span>
                    </div>

                    <div class="flex justify-between text-xl font-bold pt-2 border-t border-gray-400">
                        <span class="text-gray-800">Grand Total (Inclusive of Tax):</span>
                        <span id="grand-total" class="text-green-600">â‚¹0.00</span>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons Container -->
            <div class="flex flex-col sm:flex-row gap-4 mt-4">
                
                <!-- WhatsApp Share Button -->
                <button id="share-whatsapp-btn" onclick="shareToWhatsapp()" class="w-full sm:w-1/2 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg flex items-center justify-center space-x-2">
                    <!-- WhatsApp Icon (inline SVG for portability) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-white">
                        <path d="M12.03 2.01c-5.5 0-9.98 4.48-9.98 9.98 0 1.94.57 3.82 1.63 5.42l-1.63 5.96 6.13-1.6c1.55.84 3.32 1.28 5.12 1.28 5.5 0 9.98-4.48 9.98-9.98s-4.48-9.98-9.98-9.98zm4.73 13.92c-.22.56-.99.93-1.42 1.05-.4.11-.84.17-1.29.17-1.35 0-2.65-.5-3.64-1.32-.98-.82-1.74-2.13-1.74-3.48 0-.91.24-1.66.7-2.31.47-.64 1.15-1.07 1.94-1.25.79-.18 1.63-.08 2.37.52.75.6 1.17 1.48 1.17 2.44 0 .22-.04.42-.1.62-.07.2-.18.39-.34.56-.16.17-.35.3-.56.4-.2.11-.42.17-.65.17-.03 0-.05 0-.08 0l-.13-.02c-.52-.08-1.03-.3-1.5-.66-.47-.36-.88-.84-1.23-1.44-.06-.11-.11-.23-.15-.36-.04-.13-.05-.26-.05-.4 0-.32.13-.62.36-.85.23-.23.53-.36.85-.36.24 0 .47.05.69.15.22.1.42.25.58.44.17.2.26.43.26.69 0 .16-.03.32-.08.47-.05.15-.12.29-.2.43-.19.3-.43.56-.7.77l-.02.02c.48.37 1.03.66 1.62.86.6.2 1.24.29 1.9.29.13 0 .26-.01.39-.03.74-.12 1.34-.5 1.8-1.14.47-.64.7-1.4.7-2.28 0-.82-.26-1.5-.77-2.04-.51-.55-1.22-.84-2.12-.84h-1.5c-.32 0-.62-.13-.85-.36-.23-.23-.53-.36-.85-.36 0-.32.13-.62.36-.85.23-.23.53-.36.85-.36h1.5c.9 0 1.76.27 2.47.81.71.54 1.1 1.25 1.1 2.08 0 .5-.08.98-.24 1.44-.16.46-.37.88-.63 1.26z"/>
                    </svg>
                    <span>Share via WhatsApp</span>
                </button>

                <!-- Copy Text Button -->
                <button id="copy-quote-btn" onclick="copyToClipboard()" class="w-full sm:w-1/2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg flex items-center justify-center space-x-2">
                    <!-- Copy Icon (inline SVG) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v4a1 1 0 01-1 1H4a1 1 0 01-1-1V7a1 1 0 011-1h3a1 1 0 011 1zm4 0v4a1 1 0 01-1 1H9a1 1 0 01-1-1V7a1 1 0 011-1h3a1 1 0 011 1zm4 0v4a1 1 0 01-1 1h-3a1 1 0 01-1-1V7a1 1 0 011-1h3a1 1 0 011 1zM7 16h10" />
                    </svg>
                    <span>Copy Price Quote</span>
                </button>
            </div>

            <!-- Custom message box for UI feedback -->
            <div id="message-box" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 bg-blue-600 text-white rounded-lg shadow-xl hidden z-50 transition-opacity duration-300"></div>

        </main>
    </div>

    <!-- Quote History Modal (NEW) -->
    <div id="history-modal" class="modal">
        <div class="modal-content w-full sm:max-w-xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-2xl font-bold text-gray-800">ðŸ“š Quote History</h3>
                <button onclick="closeHistoryModal()" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <input type="text" id="history-search-input" oninput="renderHistoryList()" placeholder="Search quotes by name..." class="input-field w-full mb-4">

            <div id="history-list" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- Quote list will be rendered here -->
            </div>
            
            <p id="history-empty-state" class="text-center text-gray-500 mt-4 hidden">No saved quotes found.</p>
        </div>
    </div>


    <script>
        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Product state array
        let products = [];
        // Removed nextProductId - using UUIDs now!
        
        let globalTaxRate = 0; // Default 0%

        // Quote Management state
        let currentQuoteName = '';

        const productListEl = document.getElementById('product-list');
        const totalSubtotalEl = document.getElementById('total-subtotal');
        const totalDiscountEl = document.getElementById('total-discount');
        const netPayableEl = document.getElementById('net-payable-amount');
        const taxAmountEl = document.getElementById('tax-amount');
        const grandTotalEl = document.getElementById('grand-total');
        const globalTaxInputEl = document.getElementById('global-tax-input');
        
        const quoteNameInputEl = document.getElementById('quote-name-input');
        const messageBoxEl = document.getElementById('message-box');
        
        // Modal Elements (NEW)
        const historyModalEl = document.getElementById('history-modal');
        const historyListEl = document.getElementById('history-list');
        const historySearchInputEl = document.getElementById('history-search-input');
        const historyEmptyStateEl = document.getElementById('history-empty-state');


        /**
         * Shows a temporary message box for user feedback (e.g., successful save).
         */
        function showMessage(message, type = 'success') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600',
                warning: 'bg-yellow-600'
            };
            
            messageBoxEl.textContent = message;
            messageBoxEl.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 text-white rounded-lg shadow-xl z-50 ${colors[type]}`;
            messageBoxEl.style.opacity = '1';
            messageBoxEl.style.display = 'block';

            setTimeout(() => {
                messageBoxEl.style.opacity = '0';
                setTimeout(() => {
                    messageBoxEl.style.display = 'none';
                }, 300);
            }, 3000);
        }

        /**
         * Helper to get the correct placeholder based on discount type.
         */
        function getPlaceholder(type) {
            switch (type) {
                case 'percentage': return 'Discount % (e.g., 10)';
                case 'amount': return 'Discount Amount (â‚¹)';
                case 'final': return 'Discounted Final Price (â‚¹)';
                default: return 'Enter value';
            }
        }

        /**
         * Generates the HTML string for a single product row.
         */
        function renderProductRow(product, index) { // ADDED INDEX
            const { id, name, unitPrice, units, discountType, discountValue, subtotal, discountedPrice, discountAmount, discountPercentage, isValid } = product;
            const format = (value) => value.toFixed(2);
            
            // Apply error class if product is invalid
            const errorClass = isValid === false ? 'input-error' : '';
            const productNumber = index + 1; // 1-based index for display

            return `
                <!-- Responsive Product Row Container -->
                <div id="product-${id}" 
                     class="product-row bg-white border border-gray-200 rounded-xl shadow-sm space-y-3 p-4 md:p-0 md:border-0 md:shadow-none md:space-y-0 md:border-t md:first:border-t-0 product-row-desktop-grid">
                    
                    <!-- NEW: Product Number (#) (Desktop Column 1) -->
                    <div class="hidden md:block md:col-span-1 text-center font-bold text-lg text-indigo-600">
                        ${productNumber}.
                    </div>

                    <!-- 1. Product Name (Desktop Column 2) -->
                    <div class="md:col-span-1">
                        <label class="block">
                            <span class="text-xs font-medium text-gray-500 md:hidden">Product Name</span>
                            <input
                                type="text"
                                placeholder="Product Name (e.g., Laptop)"
                                value="${name}"
                                data-id="${id}"
                                data-field="name"
                                class="input-field text-lg font-semibold w-full"
                                oninput="handleInput(event)"
                            />
                        </label>
                    </div>

                    <!-- 2. Unit Price (Desktop Column 3) -->
                    <div class="md:col-span-1 md:block">
                        <label class="block">
                            <span class="text-xs font-medium text-gray-500 md:hidden">Unit Price (â‚¹)</span>
                            <input
                                type="number"
                                min="0"
                                step="0.01"
                                value="${unitPrice}"
                                data-id="${id}"
                                data-field="unitPrice"
                                class="input-field w-full product-unit-price-${id} ${errorClass}"
                                oninput="handleInput(event)"
                            />
                        </label>
                    </div>

                    <!-- 3. Units (Desktop Column 4) -->
                    <div class="md:col-span-1 md:block">
                        <label class="block">
                            <span class="text-xs font-medium text-gray-500 md:hidden">Units</span>
                            <input
                                type="number"
                                min="1"
                                step="1"
                                value="${units}"
                                data-id="${id}"
                                data-field="units"
                                class="input-field w-full ${errorClass}"
                                oninput="handleInput(event)"
                            />
                        </label>
                    </div>
                    
                    <!-- 4. Subtotal (Desktop Column 5) -->
                    <div class="hidden md:block md:col-span-1">
                        <div class="calculated-output text-gray-700" id="subtotal-display-desktop-${id}">
                            â‚¹${subtotal.toFixed(2)}
                        </div>
                    </div>

                    <!-- 5. Discount Setup (Desktop Column 6) -->
                    <div class="md:col-span-1 grid grid-cols-2 gap-3">
                        <!-- Discount Type Selector -->
                        <div class="col-span-1">
                            <select
                                data-id="${id}"
                                data-field="discountType"
                                class="input-field w-full bg-white text-sm"
                                onchange="handleInput(event)"
                            >
                                <option value="percentage" ${discountType === 'percentage' ? 'selected' : ''}>% Disc</option>
                                <option value="amount" ${discountType === 'amount' ? 'selected' : ''}>â‚¹ Amt</option>
                                <option value="final" ${discountType === 'final' ? 'selected' : ''}>Final â‚¹</option>
                            </select>
                        </div>

                        <!-- Discount Value Input -->
                        <div class="col-span-1">
                            <input
                                type="number"
                                min="0"
                                step="any"
                                value="${discountValue}"
                                data-id="${id}"
                                data-field="discountValue"
                                class="input-field w-full text-sm ${discountType !== 'final' && errorClass}"
                                placeholder="${getPlaceholder(discountType)}"
                                oninput="handleInput(event)"
                                ${discountType === 'none' ? 'disabled' : ''}
                            />
                        </div>
                    </div>
                    
                    <!-- 6. Discount Amount (Desktop Column 7) -->
                    <div class="hidden md:block md:col-span-1">
                        <div class="calculated-output text-red-600" id="discount-amount-display-desktop-${id}">
                            -â‚¹${discountAmount.toFixed(2)}
                        </div>
                    </div>

                    <!-- 7. Discount Percentage (Desktop Column 8) -->
                    <div class="hidden md:block md:col-span-1">
                        <div class="calculated-output text-red-600" id="discount-percent-display-desktop-${id}">
                            ${discountPercentage.toFixed(2)}%
                        </div>
                    </div>

                    <!-- 8. Product Final Price (Desktop Column 9) -->
                    <div class="hidden md:block md:col-span-1">
                        <div class="calculated-output final text-green-600" id="final-price-display-desktop-${id}">
                            â‚¹${discountedPrice.toFixed(2)}
                        </div>
                    </div>

                    <!-- 9. Remove Button (Mobile/Desktop Column 10) -->
                    <div class="md:col-span-1 flex justify-end md:justify-center">
                        <button
                            data-id="${id}"
                            class="remove-product-btn text-red-500 hover:text-red-700 p-2 rounded-full transition duration-150"
                            aria-label="Remove Product"
                            onclick="removeProduct('${id}')"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>

                    <!-- Mobile-Only Discount Details (Hidden on Desktop) -->
                    <div class="mobile-only-details md:hidden space-y-2 border-t pt-2 mt-2">
                         <div class="text-sm text-gray-600 flex justify-between">
                            <span class="font-medium">Subtotal:</span>
                            <span class="text-indigo-500 font-semibold" id="subtotal-display-mobile-${id}">â‚¹${subtotal.toFixed(2)}</span>
                        </div>
                        <div class="text-sm text-gray-600 flex justify-between">
                            <span class="font-medium">Discount Amount:</span>
                            <span id="discount-amount-display-mobile-${id}" class="font-semibold text-red-600">â‚¹${discountAmount.toFixed(2)}</span>
                        </div>
                        <div class="text-sm text-gray-600 flex justify-between">
                            <span class="font-medium">Discount %:</span>
                            <span id="discount-percent-display-mobile-${id}" class="font-semibold text-red-600">${discountPercentage.toFixed(2)}%</span>
                        </div>
                        <!-- Displayed Final Price for Mobile-Only -->
                        <div class="text-lg font-bold text-green-600 flex justify-between pt-1 border-t border-gray-300">
                            <span class="text-gray-800">Product Final Price:</span>
                            <span id="final-price-display-${id}">â‚¹${discountedPrice.toFixed(2)}</span>
                        </div>
                    </div>

                </div>
            `;
        }

        /**
         * Updates only the display elements for a specific product row.
         */
        function updateProductDisplay(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            const format = (value) => value.toFixed(2);

            // --- MOBILE Updates ---
            const subtotalMobileEl = document.getElementById(`subtotal-display-mobile-${id}`);
            if (subtotalMobileEl) subtotalMobileEl.textContent = `â‚¹${format(product.subtotal)}`;
            const discountAmountMobileEl = document.getElementById(`discount-amount-display-mobile-${id}`);
            if (discountAmountMobileEl) discountAmountMobileEl.textContent = `â‚¹${format(product.discountAmount)}`;
            const discountPercentMobileEl = document.getElementById(`discount-percent-display-mobile-${id}`);
            if (discountPercentMobileEl) discountPercentMobileEl.textContent = `${format(product.discountPercentage)}%`;
            const finalPriceEl = document.getElementById(`final-price-display-${id}`);
            if (finalPriceEl) finalPriceEl.textContent = `â‚¹${format(product.discountedPrice)}`;

            // --- DESKTOP Updates ---
            const subtotalDesktopEl = document.getElementById(`subtotal-display-desktop-${id}`);
            if (subtotalDesktopEl) subtotalDesktopEl.textContent = `â‚¹${format(product.subtotal)}`;
            const discountAmountDesktopEl = document.getElementById(`discount-amount-display-desktop-${id}`);
            if (discountAmountDesktopEl) discountAmountDesktopEl.textContent = `-â‚¹${format(product.discountAmount)}`;
            const discountPercentDesktopEl = document.getElementById(`discount-percent-display-desktop-${id}`);
            if (discountPercentDesktopEl) discountPercentDesktopEl.textContent = `${format(product.discountPercentage)}%`;
            const finalPriceDesktopEl = document.getElementById(`final-price-display-desktop-${id}`);
            if (finalPriceDesktopEl) finalPriceDesktopEl.textContent = `â‚¹${format(product.discountedPrice)}`;
        }


        /**
         * Calculates the subtotal, discount, and final discounted price for a single product.
         */
        function calculateProductTotal(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            // 1. Calculate Subtotal
            // Note: unitPrice and units are already updated by handleInput and sanitized
            
            product.subtotal = product.unitPrice * product.units;
            let finalPrice = product.subtotal;
            product.discountAmount = 0;

            // 2. Apply Discount Logic
            const discValue = product.discountValue;
            const subtotal = product.subtotal;

            switch (product.discountType) {
                case 'percentage':
                    if (discValue > 0) {
                        const discount = (subtotal * (discValue / 100));
                        product.discountAmount = Math.min(discount, subtotal);
                        finalPrice = subtotal - product.discountAmount;
                    }
                    break;
                case 'amount':
                    product.discountAmount = Math.min(discValue, subtotal);
                    finalPrice = subtotal - product.discountAmount;
                    break;
                case 'final':
                    // Final price must be between 0 and subtotal
                    finalPrice = Math.max(0, Math.min(discValue, subtotal));
                    product.discountAmount = subtotal - finalPrice;
                    break;
            }

            product.discountedPrice = finalPrice;
            
            // 3. Calculate Effective Discount Percentage
            if (product.subtotal > 0) {
                product.discountPercentage = (product.discountAmount / product.subtotal) * 100;
            } else {
                product.discountPercentage = 0;
            }

            // Update display elements without re-rendering inputs
            updateProductDisplay(id); 
            updateGrandTotals();
        }

        /**
         * Calculates and updates the overall totals summary, including Global Tax.
         */
        function updateGrandTotals() {
            let totalSubtotal = 0;
            let totalDiscount = 0;
            let netPayableAmount = 0;
            let totalDiscountPercentage = 0; 

            for (const product of products) {
                totalSubtotal += product.subtotal;
                totalDiscount += product.discountAmount;
                netPayableAmount += product.discountedPrice;
            }
            
            // 1. Calculate Discount Percentage
            if (totalSubtotal > 0) {
                totalDiscountPercentage = (totalDiscount / totalSubtotal) * 100;
            }

            // 2. Calculate Tax
            const taxRate = globalTaxRate / 100;
            const taxAmount = netPayableAmount * taxRate;
            const grandTotal = netPayableAmount + taxAmount;


            const format = (value) => `â‚¹${value.toFixed(2)}`;
            const formatPercent = (value) => `${value.toFixed(2)}%`;

            // Update Summary Display
            totalSubtotalEl.textContent = format(totalSubtotal);
            totalDiscountEl.textContent = `-${format(totalDiscount)}`;
            netPayableEl.textContent = format(netPayableAmount);
            taxAmountEl.textContent = format(taxAmount);
            // Update tax label dynamically
            document.querySelector('#totals-summary .border-t.pt-2 span:first-child').textContent = `Tax (${globalTaxRate.toFixed(1)}%):`;
            grandTotalEl.textContent = format(grandTotal);

            return { 
                totalSubtotal, 
                totalDiscount, 
                netPayableAmount, 
                taxAmount, 
                grandTotal, 
                totalDiscountPercentage 
            };
        }

        /**
         * Handles input on the global tax field.
         */
        function handleGlobalTaxInput(event) {
            let value = parseFloat(event.target.value) || 0;
            
            // Prevent negative tax rates
            if (value < 0) {
                value = 0;
                event.target.value = 0;
                showMessage("Tax rate cannot be negative.", 'warning');
            }
            // Cap max tax rate
            if (value > 100) {
                value = 100;
                event.target.value = 100;
                showMessage("Tax rate capped at 100%.", 'warning');
            }

            globalTaxRate = value;
            updateGrandTotals();
        }
        
        // --- Quote Management Functions (Updated for Modal) ---
        
        /**
         * Retrieves all quote keys from local storage.
         */
        function getAllQuoteKeys() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('quote_')) {
                    keys.push(key.substring(6)); // Return the name only
                }
            }
            return keys.sort();
        }
        
        /**
         * Opens the Quote History Modal and renders the list.
         */
        function openHistoryModal() {
            historyModalEl.classList.add('open');
            historyModalEl.style.display = 'flex';
            renderHistoryList();
        }

        /**
         * Closes the Quote History Modal.
         */
        function closeHistoryModal() {
            historyModalEl.classList.remove('open');
            setTimeout(() => {
                historyModalEl.style.display = 'none';
            }, 200);
        }
        
        /**
         * Renders the list of saved quotes inside the modal.
         */
        function renderHistoryList() {
            const savedQuoteNames = getAllQuoteKeys();
            const searchTerm = historySearchInputEl.value.toLowerCase().trim();
            
            const filteredNames = savedQuoteNames.filter(name => 
                name.toLowerCase().includes(searchTerm)
            );

            historyListEl.innerHTML = '';
            
            if (filteredNames.length === 0) {
                historyEmptyStateEl.textContent = searchTerm ? "No quotes match your search." : "No saved quotes found.";
                historyEmptyStateEl.classList.remove('hidden');
                return;
            } else {
                historyEmptyStateEl.classList.add('hidden');
            }

            filteredNames.forEach(name => {
                const quoteEl = document.createElement('div');
                quoteEl.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 shadow-sm';
                quoteEl.innerHTML = `
                    <span class="font-medium text-gray-800 truncate">${name}</span>
                    <div class="flex space-x-2 flex-shrink-0">
                        <button onclick="loadQuoteLocally('${name}'); closeHistoryModal();" class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-semibold py-1 px-3 rounded-md transition duration-150">
                            Load
                        </button>
                        <button onclick="deleteQuoteLocally('${name}')" class="text-red-500 hover:text-red-700 p-1 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
                historyListEl.appendChild(quoteEl);
            });
        }


        /**
         * Saves the current product list to local storage under the currentQuoteName.
         */
        function saveQuoteLocally() {
            const quoteName = currentQuoteName.trim();
            if (!quoteName) {
                showMessage("Please enter a name for the price quote in the input field above.", 'error');
                quoteNameInputEl.focus();
                return;
            }
            
            // Prevent saving if any product data is invalid
            const isAnyInvalid = products.some(p => p.isValid === false);
            if (isAnyInvalid) {
                showMessage("Cannot save: Please fix the invalid product inputs (highlighted in red).", 'error');
                return;
            }

            try {
                // Prepare data for saving: include globalTaxRate
                const dataToSave = {
                    taxRate: globalTaxRate,
                    products: products.map(p => ({
                        name: p.name,
                        unitPrice: p.unitPrice,
                        units: p.units,
                        discountType: p.discountType,
                        discountValue: p.discountValue,
                        // UUIDs (id) are not stored as they are regenerated on load to ensure no conflict
                    }))
                };

                localStorage.setItem(`quote_${quoteName}`, JSON.stringify(dataToSave));
                
                showMessage(`Quote "${quoteName}" saved successfully!`, 'success');
                clearQuote(); // Clear the screen after save as per previous behavior

            } catch (e) {
                showMessage("Could not save quote. Local storage might be full or unavailable.", 'error');
                console.error("Local storage error:", e);
            }
        }

        /**
         * Loads a quote from local storage and replaces the current product list.
         */
        function loadQuoteLocally(quoteName) {
            const data = localStorage.getItem(`quote_${quoteName}`);
            if (!data) return false;

            try {
                const loadedData = JSON.parse(data);
                
                // Load global tax rate
                globalTaxRate = parseFloat(loadedData.taxRate) || 0;
                globalTaxInputEl.value = globalTaxRate.toFixed(1);
                
                const loadedProducts = loadedData.products;
                products = [];

                loadedProducts.forEach(p => {
                    const newProduct = {
                        // Use UUID for the loaded product
                        id: crypto.randomUUID(), 
                        ...p,
                        subtotal: 0,
                        discountAmount: 0,
                        discountPercentage: 0,
                        discountedPrice: 0,
                        isValid: true, 
                    };
                    products.push(newProduct);
                    calculateProductTotal(newProduct.id); 
                });
                
                currentQuoteName = quoteName;
                quoteNameInputEl.value = quoteName;
                
                updateUI();
                showMessage(`Quote "${quoteName}" loaded successfully!`, 'info');
                return true;

            } catch (e) {
                showMessage("Error loading quote. Data may be corrupted.", 'error');
                console.error("Local storage parse error:", e);
                return false;
            }
        }

        /**
         * Deletes a quote from local storage.
         * @param {string} name - The name of the quote to delete.
         */
        function deleteQuoteLocally(name) {
            const quoteName = name.trim();
            if (!quoteName) return;

            try {
                if (localStorage.getItem(`quote_${quoteName}`)) {
                    localStorage.removeItem(`quote_${quoteName}`);
                    
                    showMessage(`Quote "${quoteName}" deleted.`, 'success');
                    
                    // If the deleted quote was the one currently on screen, clear the screen
                    if (currentQuoteName === quoteName) {
                        clearQuote();
                    }
                    
                    // Re-render history list if modal is open
                    if (historyModalEl.classList.contains('open')) {
                        renderHistoryList();
                    }

                } else {
                    showMessage(`Quote "${quoteName}" not found.`, 'error');
                }
            } catch (e) {
                showMessage("Could not delete quote due to storage error.", 'error');
                console.error("Local storage error:", e);
            }
        }

        /**
         * Sets the current quote name from user input.
         */
        function setCurrentQuoteName(name) {
            currentQuoteName = name.trim();
        }

        /**
         * Resets the current quote, clearing the product list and input field.
         */
        function clearQuote() {
            products = [];
            currentQuoteName = '';
            quoteNameInputEl.value = '';
            
            // Reset global tax rate
            globalTaxRate = 0;
            globalTaxInputEl.value = 0;
            
            // Do not show the message if it's called internally after a save/delete
            if (event && event.currentTarget.id === 'clear-quote-btn') {
                 showMessage("Quote cleared. Ready for a new quote!", 'info');
            }
            addProduct(true); 
        }
        
        // --- Core UI Functions ---

        /**
         * Re-renders the entire product list (ONLY used on ADD or REMOVE product or discount type change).
         */
        function updateUI() {
            // Map products to HTML, passing the index for product numbering (NEW)
            productListEl.innerHTML = products.map(renderProductRow).join('');
            
            products.forEach(p => calculateProductTotal(p.id)); 
            
            updateGrandTotals();
        }

        /**
         * Centralized handler for all product input changes, including validation.
         */
        function handleInput(event) {
            const input = event.target;
            // UUIDs are strings, so no parseInt needed here (NEW)
            const id = input.dataset.id; 
            const field = input.dataset.field;
            const product = products.find(p => p.id === id);

            if (!product) return;

            let value = input.value;
            let isValid = true;
            let message = '';
            
            // 1. Handle value type and basic validation
            if (field === 'name') {
                product[field] = value;
            } else if (field === 'discountType') {
                product.discountValue = 0;
                product.discountType = value;
                product.isValid = true; // Reset validity for this product
                updateUI(); // Re-render to update discount placeholder
                return; 
            } else {
                // Numeric fields (unitPrice, units, discountValue)
                product[field] = parseFloat(value) || 0;
                
                // Price & Units must be > 0 (Units must be >= 1)
                if ((field === 'unitPrice' && product[field] <= 0) || 
                    (field === 'units' && product[field] < 1)) {
                    isValid = false;
                    message = `Product ${field === 'unitPrice' ? 'Price' : 'Units'} must be greater than zero.`;
                }

                // Discount Value validation (if not final price)
                if (field === 'discountValue' && product.discountType !== 'final') {
                    if (product[field] < 0) {
                        isValid = false;
                        message = "Discount value cannot be negative.";
                    }
                    if (product.discountType === 'percentage' && product[field] > 100) {
                        isValid = false;
                        message = "Percentage discount cannot exceed 100%.";
                    }
                }
            }

            // 2. Update UI based on validation result
            product.isValid = isValid;

            if (isValid) {
                input.classList.remove('input-error');
            } else {
                input.classList.add('input-error');
                // Only show persistent error messages if they are currently invalid
                showMessage(message, 'warning');
            }

            calculateProductTotal(id);
        }

        /**
         * Adds a new product row to the list.
         * @param {boolean} [startEmpty=false] - If true, starts a blank quote.
         */
        function addProduct(startEmpty = false) {
            const initialPrice = 0.00; 
            const initialDiscount = 0;
            
            const newProduct = {
                // Use a proper UUID (Universally Unique Identifier) (NEW)
                id: crypto.randomUUID(), 
                name: `Product ${products.length + 1}`,
                unitPrice: initialPrice,
                units: 1,
                discountType: 'percentage',
                discountValue: initialDiscount,
                subtotal: 0,
                discountAmount: 0,
                discountPercentage: 0,
                discountedPrice: 0,
                isValid: true, 
            };
            products.push(newProduct);
            calculateProductTotal(newProduct.id);
            updateUI();
            
            // Focus logic needs a slight delay to ensure the element exists after DOM update
            setTimeout(() => {
                const newProductEl = document.getElementById(`product-${newProduct.id}`);
                if (newProductEl) {
                    newProductEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Focus on the Unit Price field
                    const unitPriceInput = newProductEl.querySelector(`[data-field="unitPrice"]`);
                    if (unitPriceInput) {
                        unitPriceInput.focus();
                        unitPriceInput.select(); 
                    }
                }
            }, 0);
        }

        /**
         * Removes a product row from the list.
         */
        function removeProduct(id) {
            products = products.filter(p => p.id !== id);
            // If all products are deleted, start a new blank one
            if (products.length === 0) {
                addProduct(true);
            } else {
                updateUI();
            }
        }

        // --- Copy/Share Functions ---
        
        function generateWhatsappSummaryText() {
            const totals = updateGrandTotals(); 
            const productDetails = products.map((product, index) => {
                const formatPrice = (value) => value.toFixed(2);
                const productNumber = index + 1;

                // Use * for bold and _ for italics in WhatsApp markdown
                return `
*${productNumber}. ${product.name || 'Untitled Product'}*
    Unit Price: â‚¹${formatPrice(product.unitPrice)}
    Units: ${product.units}
    Subtotal: â‚¹${formatPrice(product.subtotal)}
    _Discount Applied:_ -â‚¹${formatPrice(product.discountAmount)} (${product.discountPercentage.toFixed(2)}%)
    *Product Final Price: â‚¹${formatPrice(product.discountedPrice)}*`; 
            }).join('\n');

            const summary = `
*ðŸ’° PRICE QUOTE SUMMARY*
${currentQuoteName ? `*Quote:* ${currentQuoteName}\n` : ''}_Prepared using Discount Calculator Pro_

*--- PRODUCT DETAILS ---*
${productDetails}

*--- GRAND TOTAL ---*

Total Subtotal: *â‚¹${totals.totalSubtotal.toFixed(2)}*
Total Savings: *-â‚¹${totals.totalDiscount.toFixed(2)}*
Net Amount (Before Tax): *â‚¹${totals.netPayableAmount.toFixed(2)}*
Tax Applied (${globalTaxRate.toFixed(1)}%): *+â‚¹${totals.taxAmount.toFixed(2)}*
*NET PAYABLE AMOUNT (INCL. TAX): â‚¹${totals.grandTotal.toFixed(2)}*`;
            return summary.trim();
        }
        
        function shareToWhatsapp() {
            const encodedText = encodeURIComponent(generateWhatsappSummaryText());
            // Use window.location.host as a fallback if window.location.origin is empty
            const appLink = `\n\nGenerated with: ${window.location.origin || window.location.host}`;
            const whatsappUrl = `https://wa.me/?text=${encodedText}${encodeURIComponent(appLink)}`;
            window.open(whatsappUrl, '_blank');
        }

        function copyToClipboard() {
            const summaryText = generateWhatsappSummaryText(); 
            const copyButton = document.getElementById('copy-quote-btn');
            
            // Include a subtle reference to the app in the copied text for sharing context
            const fullTextToCopy = summaryText + `\n\nGenerated with Discount Calculator Pro.`;

            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = fullTextToCopy;
            tempTextArea.style.position = 'fixed';
            tempTextArea.style.top = '0';
            tempTextArea.style.left = '0';
            tempTextArea.style.opacity = '0';
            
            document.body.appendChild(tempTextArea);
            tempTextArea.focus();
            tempTextArea.select();

            let successful = false;
            try {
                successful = document.execCommand('copy');
            } catch (err) {
                console.error('Copy command failed:', err);
            }
            document.body.removeChild(tempTextArea);
            
            if (successful) {
                const originalContent = copyButton.innerHTML;
                copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> <span>Copied!</span>`;
                copyButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                copyButton.classList.add('bg-blue-500', 'hover:bg-blue-600'); 

                setTimeout(() => {
                    copyButton.innerHTML = originalContent;
                    copyButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    copyButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
                }, 2000);
            } else {
                showMessage('Failed to copy text automatically.', 'error');
            }
        }


        // --- Initialization ---
        window.onload = function() {
            // Load tax rate
            const savedTax = localStorage.getItem('globalTaxRate');
            if (savedTax !== null) {
                globalTaxRate = parseFloat(savedTax) || 0;
                globalTaxInputEl.value = globalTaxRate.toFixed(1);
            } else {
                globalTaxRate = 0;
            }

            // Start with one product if the list is empty
            if (products.length === 0) {
                 addProduct(true); 
            } else {
                updateUI(); 
            }
        }
    </script>
</body>
</html>

